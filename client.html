HTTP/1.1 200 OK
Content-Type: text/html
Connection: Keep-Alive

<!DOCTYPE html>
<html>
<head>
    <title>Halo, Selamat Datang!</title>
    <style>
        .notification {
            color: #666;
            font-style: italic;
            margin: 5px 0;
        }
        .message {
            margin: 5px 0;
        }
        #output {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        .system-message {
            color: #007bff;
            font-style: italic;
        }
        #activeUsers {
            margin: 10px 0;
            padding: 10px;
            background: #eef;
            border-radius: 4px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn-logout {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-logout:hover {
            background-color: #c82333;
        }
        .btn-send {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-send:hover {
            background-color: #218838;
        }
        .btn-login {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-login:hover {
            background-color: #0056b3;
        }
        .input-group {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <h1>Contoh Chat dengan WebSocket</h1>
    
    <!-- Form untuk username -->
    <div id="loginForm">
        <div class="input-group">
            <input type="text" id="usernameInput" placeholder="Masukkan username">
            <button class="btn-login" onclick="setUsername()">Masuk</button>
        </div>
    </div>

    <!-- Area chat yang awalnya tersembunyi -->
    <div id="chatArea" style="display: none;">
        <div class="header">
            <p>Selamat datang, <span id="userLabel"></span>!</p>
            <button class="btn-logout" onclick="logout()">Keluar</button>
        </div>
        
        <div id="activeUsers">
            <strong>Users Online:</strong> <span id="userList"></span>
        </div>
        <div id="output"></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Masukkan pesan">
            <button class="btn-send" onclick="sendMessage()">Kirim</button>
        </div>
    </div>

    <script>
        let ws = null;
        let username = '';

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:6789');
            
            ws.onopen = () => {
                appendMessage('Terhubung ke server', 'system-message');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'user_list') {
                    document.getElementById('userList').textContent = data.users.join(', ');
                } else if (data.type === 'notification') {
                    appendMessage(data.message, 'notification');
                } else if (data.type === 'message') {
                    appendMessage(data.message, 'message');
                }
            };

            ws.onclose = () => {
                appendMessage('Terputus dari server', 'system-message');
            };
        }

        function appendMessage(message, type = 'message') {
            const output = document.getElementById('output');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            output.appendChild(messageDiv);
            output.scrollTop = output.scrollHeight;
        }

        function setUsername() {
            username = document.getElementById('usernameInput').value.trim();
            if (username) {
                // Buat koneksi WebSocket baru
                connectWebSocket();
                
                // Tunggu sampai koneksi terbuka
                setTimeout(() => {
                    ws.send(JSON.stringify({
                        type: 'login',
                        username: username
                    }));
                    
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('chatArea').style.display = 'block';
                    document.getElementById('userLabel').textContent = username;
                }, 500);
            } else {
                alert('Username tidak boleh kosong!');
            }
        }

        function logout() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Kirim pesan logout ke server
                ws.send(JSON.stringify({
                    type: 'logout',
                    username: username
                }));
                
                // Tunggu sebentar agar pesan logout terkirim sebelum menutup koneksi
                setTimeout(() => {
                    ws.close();
                    resetUI();
                }, 500);
            } else {
                resetUI();
            }
        }

        function resetUI() {
            // Reset UI
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('chatArea').style.display = 'none';
            document.getElementById('output').innerHTML = '';
            document.getElementById('usernameInput').value = '';
            username = '';
            ws = null;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'message',
                    username: username,
                    content: message
                }));
                messageInput.value = '';
            }
        }

        // Event listener untuk input field
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('usernameInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setUsername();
            }
        });

        // Handle window close/refresh
        window.onbeforeunload = function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'logout',
                    username: username
                }));
            }
        };
    </script>
</body>
</html>